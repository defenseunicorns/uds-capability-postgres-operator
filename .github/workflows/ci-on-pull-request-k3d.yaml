on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - ".gitignore"
      - "LICENSE"
      - "**/*.md"
      - "**/*.json"
      - "**/*.png"
      - "**/*.svg"

permissions:
  id-token: write
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout repository
          uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

        - name: Login to Registry1
          uses: docker/login-action@v3
          with:
            registry: registry1.dso.mil
            username: ${{ secrets.REGISTRY1_USERNAME }}
            password: ${{ secrets.REGISTRY1_PASSWORD }}
  
        - name: Install Zarf
          uses: defenseunicorns/setup-zarf@main
          with:
            # renovate: datasource=github-tags depName=defenseunicorns/zarf versioning=semver
            version: v0.30.1
            download-init-package: true

        - name: Install k3d
          run: |
            curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

        - name: Build and Test Capability via Zarf
          shell: bash
          run: zarf package create --confirm
          working-directory: ".github/test-infra"
